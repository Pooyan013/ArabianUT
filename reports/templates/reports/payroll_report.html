{% extends "reports/base_report.html" %}
{% block title %}Payroll Report{% endblock %}

{% block report_content %}
{# فرم فیلتر تاریخ که فیلدهای لازم را دارد #}
<form method="get" class="row g-3 align-items-center mb-4 p-3 bg-light rounded">
    <div class="col-md-4">
        <label for="id_start_date" class="form-label">Start Date</label>
        {{ form.start_date }}
    </div>
    <div class="col-md-4">
        <label for="id_end_date" class="form-label">End Date</label>
        {{ form.end_date }}
    </div>
    <div class="col-md-2 align-self-end">
        <button type="submit" class="btn btn-secondary w-100">Filter</button>
    </div>
    <div class="col-md-2 align-self-end">
        <a href="#" class="btn btn-success w-100 disabled"><i class="bi bi-file-earmark-excel"></i> Export</a>
    </div>
</form>

<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead>
            <tr>
                <th>NAME</th>
                <th>SALARY</th>
                <th>REMAINING BEFORE</th>
                <th>PAID</th>
                <th>EXTRA H</th>
                <th>MINES H</th>
                <th>EXTRA</th>
                <th>MINES</th>
                <th>REST</th>
                <th>COST</th>
                <th>ABSENCES (Days)</th>
                <th>Description / Personal Transactions</th>
            </tr>
        </thead>
        <tbody>
            {% for slip in salary_slips %}
            <tr>
                <td>{{ slip.employee.full_name }}</td>
                <td>{{ slip.employee.base_salary|floatformat:2 }}</td>
                <td>{{ slip.remaining_before|floatformat:2 }}</td>
                <td>{{ slip.paid|floatformat:2 }}</td>
                <td>{{ slip.extra_h|floatformat:2 }}</td>
                <td>{{ slip.mines_h|floatformat:2 }}</td>
                <td>{{ slip.extra|floatformat:2 }}</td>
                <td>{{ slip.mines|floatformat:2 }}</td>
                <td>{{ slip.rest|floatformat:2 }}</td>
                <td>{{ slip.cost|floatformat:2 }}</td>
                <td>{{ slip.absence_count }}</td>
                <td>
                    {# START: نمایش لیست تراکنش‌های شخصی #}
                    {% if slip.description %}
                    <p class="mb-1"><strong>Note:</strong> {{ slip.description }}</p>
                    {% endif %}

                    <ul class="list-unstyled mb-0">
                        {% for expense in slip.personal_expenses %}
                        <li>
                            {% if expense.personal_type == 'advance' %}
                            <span class="badge bg-danger">Advance</span>
                            {% else %}
                            <span class="badge bg-success">Reimbursement</span>
                            {% endif %}
                            {{ expense.description }} - <strong>{{ expense.amount|floatformat:2 }}</strong>
                        </li>
                        {% endfor %}
                    </ul>
                </td>
            </tr>
            {% empty %}
            {# این بخش زمانی نمایش داده می‌شود که هیچ فیش حقوقی وجود نداشته باشد #}
            <tr>
                <td colspan="12" class="text-center py-5">No salary slips found for the selected criteria.</td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr class="table-dark">
                <td colspan="10" class="text-end fw-bold">Grand Total Cost:</td>
                <td class="fw-bold">{{ total_cost_sum|floatformat:2 }}</td>
                <td></td>
            </tr>
        </tfoot>
    </table>
</div>
{% endblock report_content %}