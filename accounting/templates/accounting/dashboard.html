{% extends "core/base.html" %}
{% load static %}
{% load accounting_tags %} {% block title %}Accounting Dashboard{% endblock %}

{% block content %}
<div class="container my-5">

    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="get" class="row g-3 align-items-end">
                <div class="col-md-3">
                    <label for="type-filter" class="form-label small text-muted">Filter by Type</label>
                    <select name="type" id="type-filter" class="form-select">
                        <option value="">All Types</option>
                        {% with request.GET.type as type_filter %}
                        <option value="income" {% if type_filter == "income" %}selected{% endif %}>Income</option>
                        <option value="expense" {% if type_filter == "expense" %}selected{% endif %}>Expense</option>
                        {% endwith %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="from-date" class="form-label small text-muted">From Date</label>
                    <input type="date" name="from" id="from-date" class="form-control" value="{{ request.GET.from }}">
                </div>
                <div class="col-md-3">
                    <label for="to-date" class="form-label small text-muted">To Date</label>
                    <input type="date" name="to" id="to-date" class="form-control" value="{{ request.GET.to }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">Filter</button>
                </div>
                <div class="col-md-1">
                     <a href="{% url 'accounting:export_excel' %}?{{ request.GET.urlencode }}" class="btn btn-success w-100" title="Export to Excel">
                        <i class="bi bi-file-earmark-excel"></i>
                    </a>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-header d-flex justify-content-between align-items-center bg-light">
            <h4 class="mb-0">Recent Transactions</h4>
            <div>
                <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#incomeModal">
                    <i class="bi bi-plus-circle me-1"></i> Add Income
                </button>
                <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#expenseModal">
                    <i class="bi bi-dash-circle me-1"></i> Add Expense
                </button>
                <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#buyPartModal">
                    <i class="bi bi-cart-plus me-1"></i> Buy Car Part
                </button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead class="table-light">
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Source / Category</th>
                        <th>Paid From</th>
                        <th>Recorded By</th>
                        <th class="text-end">Amount</th>
                    </tr>
                </thead>
                <tbody>
                    {% for tx in page_obj %}
                    <tr>
                        <td>{{ tx.transaction_date|date:"Y-m-d H:i" }}</td>
                        <td>
                            {% if tx.amount > 0 %}<span class="badge bg-success-subtle text-success-emphasis rounded-pill">Income</span>
                            {% else %}<span class="badge bg-danger-subtle text-danger-emphasis rounded-pill">Expense</span>{% endif %}
                        </td>
                        <td>{{ tx.description }}</td>
                        <td>
                            {% if tx.repair_job %} {{ tx.repair_job.car }}
                            {% elif tx.related_part.repair_job %} {{ tx.related_part.repair_job.car }}
                            {% elif tx.source %} {{ tx.source }}
                            {% elif tx.category %} {{ tx.category.name }}
                            {% else %} - {% endif %}
                        </td>
                        <td>
                            {% if tx.amount < 0 and tx.payment_source %}
                                {{ tx.get_payment_source_display }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if tx.recorded_by %} {{ tx.recorded_by.get_full_name|default:tx.recorded_by.username }}
                            {% else %} - {% endif %}
                        </td>
                        <td class="text-end fw-bold {% if tx.amount > 0 %}text-success{% else %}text-danger{% endif %}">
                            {{ tx.amount|floatformat:2 }}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="7" class="text-center py-5">No transactions found.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            </div>
        </div>
        
        {% if page_obj.has_other_pages %}
        <div class="card-footer">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    
                    {% if page_obj.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?{% url_replace page=page_obj.previous_page_number %}">&laquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% for i in page_obj.paginator.page_range %}
                        {% if page_obj.number == i %}
                            <li class="page-item active" aria-current="page"><span class="page-link">{{ i }}</span></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?{% url_replace page=i %}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if page_obj.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?{% url_replace page=page_obj.next_page_number %}">&raquo;</a>
                        </li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&raquo;</span></li>
                    {% endif %}

                </ul>
            </nav>
        </div>
        {% endif %}
        </div>

    <div class="modal fade" id="incomeModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'accounting:dashboard' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Add Income</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="{{ income_form.repair_job.id_for_label }}" class="form-label">Related Repair Job (Optional):</label>
                            {{ income_form.repair_job }}
                        </div>
                        <div class="mb-3" id="source-field">
                            <label for="{{ income_form.source.id_for_label }}" class="form-label">Source of Income (if no job selected):</label>
                            {{ income_form.source }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ income_form.description.id_for_label }}" class="form-label">Description:</label>
                            {{ income_form.description }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ income_form.amount.id_for_label }}" class="form-label">Amount:</label>
                            {{ income_form.amount }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="add_income" class="btn btn-success">Save Income</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="expenseModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'accounting:dashboard' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Add Expense</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label d-block">Paid From</label>
                            {% for radio in simple_expense_form.payment_source %}
                            <div class="form-check form-check-inline">
                                {{ radio.tag }}
                                <label class="form-check-label" for="{{ radio.id_for_label }}">{{ radio.choice_label }}</label>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ simple_expense_form.expense_type.id_for_label }}" class="form-label">Expense Type</label>
                            {{ simple_expense_form.expense_type }}
                        </div>
                        <div id="conditional-expense-fields">
                            <div class="mb-3" id="garage-category-field" style="display: none;">
                                <label for="{{ simple_expense_form.category.id_for_label }}" class="form-label">Garage Category</label>
                                {{ simple_expense_form.category }}
                            </div>
                            <div class="mb-3" id="expense-description-field" style="display: none;">
                                <label for="{{ simple_expense_form.description.id_for_label }}" class="form-label">Description</label>
                                {{ simple_expense_form.description }}
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="{{ simple_expense_form.amount.id_for_label }}" class="form-label">Amount</label>
                            {{ simple_expense_form.amount }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ simple_expense_form.recorded_by.id_for_label }}" class="form-label">Recorded by</label>
                            {{ simple_expense_form.recorded_by }}
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="add_simple_expense" class="btn btn-danger">Save Expense</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="buyPartModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="post" action="{% url 'accounting:dashboard' %}">
                    {% csrf_token %}
                    <div class="modal-header">
                        <h5 class="modal-title">Buy Car Part</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="{{ buy_part_form.car.id_for_label }}" class="form-label">Car</label>
                            {{ buy_part_form.car }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ buy_part_form.part.id_for_label }}" class="form-label">Part</label>
                            {{ buy_part_form.part }}
                        </div>
                        <div class="mb-3">
                            <label for="{{ buy_part_form.price.id_for_label }}" class="form-label">Price</label>
                            {{ buy_part_form.price }}
                        </div>
                        <div class="mb-3" id="part-image-container" style="display:none;">
                            <label class="form-label">Part Image</label>
                            <img id="part-image" src="" alt="Part Image" class="img-fluid rounded border" style="max-height:150px;">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" name="buy_part" class="btn btn-primary">Submit Purchase</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {

    // --- LOGIC FOR THE "ADD INCOME" MODAL ---
    const repairJobField = document.getElementById('{{ income_form.repair_job.id_for_label }}');
    const sourceField = document.getElementById('source-field');
    
    function toggleSourceField() {
        if (!repairJobField || !sourceField) return;
        if (!repairJobField.value) { sourceField.style.display = 'block'; } 
        else { sourceField.style.display = 'none'; }
    }
    if (repairJobField) {
        repairJobField.addEventListener('change', toggleSourceField);
        toggleSourceField();
    }

    // --- LOGIC FOR THE "ADD EXPENSE" MODAL ---
    const expenseTypeSelect = document.getElementById('{{ simple_expense_form.expense_type.id_for_label }}');
    const garageCategoryField = document.getElementById('garage-category-field');
    const descriptionField = document.getElementById('expense-description-field');

    function toggleExpenseFields() {
        if (!expenseTypeSelect) return; 
        const selectedType = expenseTypeSelect.value;
        if(garageCategoryField) garageCategoryField.style.display = 'none';
        if(descriptionField) descriptionField.style.display = 'none';
        if (selectedType === 'garage') {
            if(garageCategoryField) garageCategoryField.style.display = 'block';
        } else if (selectedType === 'personal' || selectedType === 'other') {
            if(descriptionField) descriptionField.style.display = 'block';
        }
    }
    if (expenseTypeSelect) {
        expenseTypeSelect.addEventListener('change', toggleExpenseFields);
        toggleExpenseFields();
    }

    // --- LOGIC FOR THE "BUY CAR PART" MODAL (AJAX) ---
    const carField = document.getElementById('{{ buy_part_form.car.id_for_label }}');
    const partField = document.getElementById('{{ buy_part_form.part.id_for_label }}');
    const partImageContainer = document.getElementById('part-image-container');
    const partImage = document.getElementById('part-image');

    if (carField) {
        carField.addEventListener('change', function () {
            const carId = carField.value;
            if (!carId) {
                partField.innerHTML = '<option value="">--- Select Car First ---</option>';
                return;
            }
            fetch(`/accounting/ajax/get_parts/?car_id=${carId}`)
                .then(response => response.json())
                .then(data => {
                    partField.innerHTML = '<option value="">--- Select Part ---</option>';
                    data.parts.forEach(function (item) {
                        const option = document.createElement('option');
                        option.value = item.id;
                        option.text = item.name;
                        if(item.picture) { option.setAttribute('data-image', item.picture); } 
                        else { option.setAttribute('data-image', ''); }
                        partField.appendChild(option);
                    });
                    if(partImageContainer) partImageContainer.style.display = 'none';
                    if(partImage) partImage.src = '';
                })
                .catch(error => {
                    console.error('Error fetching parts:', error);
                    partField.innerHTML = '<option value="">--- Error Loading Parts ---</option>';
                });
        });
    }

    if (partField) {
        partField.addEventListener('change', function () {
            const selectedOption = partField.options[partField.selectedIndex];
            if (!selectedOption || !selectedOption.dataset.image || selectedOption.dataset.image === 'null' || selectedOption.dataset.image === '') {
                if(partImageContainer) partImageContainer.style.display = 'none';
                return;
            }
            const imageUrl = selectedOption.getAttribute('data-image');
            if(partImage) partImage.src = imageUrl;
            if(partImageContainer) partImageContainer.style.display = 'block';
        });
    }
});
</script>
{% endblock %}