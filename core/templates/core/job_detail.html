{% extends "core/base.html" %}
<!-- prettier-ignore -->
{% block title %}Job Details for {{ job.car.plate_number }}{% endblock title %}

{% block content %}
<div class="container-fluid my-4">
    {% if messages %}
    {% for message in messages %}
    <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}

    <div class="row">
        {# --- START: Left Column --- #}
        <div class="col-lg-4">
            <!-- Card 1: Car Information -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Car Information</h5>
                    <a href="{% url 'core:edit_car' job.car.id %}" class="btn btn-sm btn-outline-light">Edit</a>
                </div>
                <div class="card-body">
                    {% if job.car.car_picture %}
                    <img src="{{ job.car.car_picture.url }}" class="img-fluid rounded mb-3"
                        alt="{{ job.car.brand }} {{ job.car.model }}">
                    {% endif %}
                    <p><strong>Brand:</strong> {{ job.car.brand }}</p>
                    <p><strong>Model:</strong> {{ job.car.model }}</p>
                    <p><strong>Plate Number:</strong> {{ job.car.plate_number }}</p>
                    <p><strong>Registered By:</strong> {{ job.car.registered_by.username|default:"-" }}</p>
                    <hr>
                    <p><strong>Claim Number:</strong> {{ job.car.claim_number }}</p>
                    <p><strong>Estimated Cost:</strong> {{ job.car.get_estimated_cost_display }}</p>
                    <p><strong>Registered At:</strong> {{ job.car.registered_at|date:"Y-m-d H:i" }}</p>
                </div>
            </div>

            <!-- Card 2: Part Management -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">Part Management</h5>
                </div>
                <div class="card-body">
                    <h6>Add a New Part</h6>
                    <form method="post" enctype="multipart/form-data" class="mb-4">
                        {% csrf_token %}
                        {{ part_form.as_p }}
                        <button type="submit" name="add_part" class="btn btn-primary w-100 mt-2">Add Part</button>
                    </form>
                    <hr>

                    <h6>Logged Parts List</h6>
                    <ul class="list-group">
                        {% for part in parts %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
                                <button type="button" class="btn btn-sm btn-outline-primary" {% if part.is_bought %}
                                    disabled {% endif %} data-part-id="{{ part.id }}" data-part-name="{{ part.name }}"
                                    data-bs-toggle="modal" data-bs-target="#buyPartModal">
                                    {% if part.is_bought %} Bought {% else %} Mark as Bought {% endif %}
                                </button>
                                {% if part.picture %}
                                <button type="button" class="btn btn-sm btn-outline-info" data-bs-toggle="modal"
                                    data-bs-target="#viewPartImageModal" data-part-name="{{ part.name }}"
                                    data-part-image-url="{{ part.picture.url }}">
                                    View Image
                                </button>
                                {% endif %}
                                <span class="{% if part.is_bought %}text-decoration-line-through{% endif %} ms-3">
                                    {{ part.name }} - {{ part.price|floatformat:2 }}
                                </span>
                            </div>
                            <form action="{% url 'core:delete_part' part.id %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-sm btn-outline-danger"
                                    onclick="return confirm('Are you sure?');">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </form>
                        </li>
                        {% empty %}
                        <li class="list-group-item">No parts added yet.</li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
        {# --- END: Left Column --- #}

        {# --- START: Right Column (Workflow) --- #}
        <div class="col-lg-8">
            <div class="card-body p-4">
                <div class="card shadow-sm">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Job Workflow</h5>
                        <span class="badge bg-primary fs-6">{{ job.get_status_display }}</span>
                    </div>
                    <div class="card-body p-4">

                        {# --- All stage-specific logic is now in the right column --- #}
                        {% if job.status == 'pending_expert' %}
                        <div class="text-center p-4">
                            <h5 class="mb-3">Waiting for Expert Inspection</h5>
                            <p>The car is waiting to be inspected by a technical expert.</p>
                            <form action="{% url 'core:update_job_status' job.id 'quotation' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">Mark as Inspected & Proceed to
                                    Quotation</button>
                            </form>
                        </div>
                        {% endif %}

                        {# --- Stage: Quotation --- #}
                        {% if job.status == 'quotation' %}
                        <div class="p-2">
                            <h5>Quotation Stage</h5>
                            <p>Add the required items for the pro-forma invoice. This data will be used for the
                                PDF export.
                            </p>

                            <form method="post" enctype="multipart/form-data" class="mb-4 border p-3 rounded">
                                <h6>Add Quotation Item</h6>
                                {% csrf_token %}

                                <div class="mb-3">
                                    <label for="id_item_name" class="form-label">Item (select from list):</label>
                                        <select name="item_name" id="id_item_name" class="form-select">
                                    {% for choice in quotation_item_form.fields.item_name.choices %}
                                    <option value="{{ choice.0 }}" {% if quotation_item_form.initial.item_name|stringformat:"s" == choice.0|stringformat:"s" %}selected{% endif %}>
                                        {{ choice.1 }}
                                    </option>
                                     {% endfor %}
                                    </select>
                                </div>

                                <div class="mb-3" id="custom-name-field" style="display:none;">
                                    <label for="id_custom_name" class="form-label">Custom Item Name (if not in
                                        list):</label>
                                    <input type="text" name="custom_name" id="id_custom_name" class="form-control"
                                        value="{{ quotation_item_form.custom_name.value|default_if_none:'' }}">
                                </div>

                                {{ quotation_item_form.price.label_tag }}
                                {{ quotation_item_form.price }}

                                {{ quotation_item_form.quantity.label_tag }}
                                {{ quotation_item_form.quantity }}

                                {{ quotation_item_form.position.label_tag }}
                                {{ quotation_item_form.position }}

                                <button type="submit" name="add_quotation_item" class="btn btn-info mt-2">Add
                                    Item</button>
                            </form>

                            <h6>Quotation Items List</h6>
                            <ul class="list-group mb-4">
                                {% for item in quotation_items %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <span>
                                        {% if item.custom_name %}
                                        {{ item.custom_name|safe }}
                                        {% elif item.item_name %}
                                        {{ item.item_name }}
                                        {% else %}
                                        Unknown Item
                                        {% endif %}
                                        ({{ item.price|floatformat:2 }}) x {{ item.quantity }}
                                        {% if item.position != 'unknown' %}
                                        - Position: {{ item.get_position_display }}
                                        {% endif %}
                                    </span>
                                    <form action="{% url 'core:delete_quotation_item' item.id %}" method="post">
                                        {% csrf_token %}
                                        <button type="submit" class="btn btn-sm btn-danger"
                                            onclick="return confirm('Are you sure?');">Delete</button>
                                    </form>
                                </li>
                                {% empty %}
                                <li class="list-group-item">No items added yet.</li>
                                {% endfor %}
                            </ul>

                            <div class="text-center mt-4 d-flex justify-content-center gap-2">
                                <a href="{% url 'core:quotation_pdf' job.id %}" target="_blank"
                                    class="btn btn-secondary">
                                    <i class="bi bi-file-earmark-pdf"></i> Download PDF
                                </a>
                                <form action="{% url 'core:update_job_status' job.id 'pending_approval' %}"
                                    method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">Finalize & Proceed</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}
                        {% if job.status == 'pending_approval' %}
                        <div class="p-2">
                            <h5>Approval Stage</h5>
                            <p>Enter the final deal amount from the insurance company.</p>
                            <form method="post" class="mb-4 border p-3 rounded">
                                {% csrf_token %}
                                {{ deal_form.as_p }}
                                <button type="submit" name="update_deal" class="btn btn-info">Update
                                    Deal</button>
                            </form>
                            <div class="text-center mt-4">
                                <form action="{% url 'core:update_job_status' job.id 'pending_start' %}" method="post">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-success">Proceed to Start</button>
                                </form>
                            </div>
                        </div>
                        {% endif %}

                        {# --- Stages with Timer --- #}
                        {% if job.status in "pending_start,pending_part,working" %}
                        <div class="text-center p-3">
                            <h5>Repair Timer</h5>

                            {% if job.timer_end_time %}
                            <div id="countdown-timer"
                                class="fs-4 fw-bold {% if job.timer_paused_at %}text-warning{% else %}text-primary{% endif %}"
                                data-end-time="{{ job.timer_end_time.isoformat }}"
                                data-paused-at="{% if job.timer_paused_at %}{{ job.timer_paused_at.isoformat }}{% endif %}">
                            </div>
                            <p class="text-muted small">Estimated completion by:
                                {{ job.timer_end_time|date:"Y-m-d H:i" }}
                            </p>
                            {% else %}
                            <p>Timer not started yet.</p>
                            {% endif %}
                        </div>
                        <hr>
                        <div class="d-flex justify-content-center gap-2">
                            {% if job.status == 'working' %}
                            <form action="{% url 'core:update_job_status' job.id 'ready_to_exit' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success">Finish Work</button>
                            </form>
                            {% endif %}

                            {% if job.timer_start_time %}
                            {% if job.timer_paused_at %}
                            <form action="{% url 'core:resume_timer' job.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-info">Resume Timer</button>
                            </form>
                            {% else %}
                            <form action="{% url 'core:pause_timer' job.id %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning">Pause Timer</button>
                            </form>
                            {% endif %}
                            {% endif %}
                        </div>
                        {% endif %}
                        <hr>
                        <div class="d-flex justify-content-center gap-2">
                            {% if job.status == 'pending_start' %}
                            <form action="{% url 'core:update_job_status' job.id 'working' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">Start Work</button>
                            </form>
                            <form action="{% url 'core:update_job_status' job.id 'pending_part' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-warning">Order Parts</button>
                            </form>
                            {% elif job.status == 'pending_part' %}
                            <form action="{% url 'core:update_job_status' job.id 'working' %}" method="post">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-primary">Parts Received, Start
                                    Work</button>
                            </form>
                            {% elif job.status == 'working' %}
                            <form action="{% url 'core:update_job_status' job.id 'ready_to_exit' %}" method="post">
                                {% csrf_token %}<button type="submit" class="btn btn-success">Finish
                                    Work</button></form>
                            {% endif %}
                        </div>

                        {# --- Stage: Ready To Exit --- #}
                        {% if job.status == 'ready_to_exit' %}
                        <div class="text-center p-4">
                            <h5>Ready for Delivery</h5>
                            <p>Please confirm the customer signature has been received to proceed.</p>

                            <form method="post" class="border p-4 rounded mt-3 d-inline-block text-start">
                                {% csrf_token %}
                                {{ sign_form.as_p }}
                                <button type="submit" name="confirm_sign" class="btn btn-primary w-100 mt-2">
                                    Confirm Signature & Proceed
                                </button>
                            </form>
                        </div>
                        {% endif %}

                        {# --- Stage: Exit --- #}
                        {% if job.status == 'exit' %}
                        <div class="text-center p-4">
                            <h5>Final Step: LPO Confirmation</h5>
                            <p>Confirm the LPO is positive to archive the job.</p>

                            <form method="post" class="border p-4 rounded mt-3 d-inline-block text-start">
                                {% csrf_token %}
                                {{ lpo_form.as_p }}
                                <button type="submit" name="confirm_lpo" class="btn btn-success w-100 mt-2">
                                    <i class="bi bi-archive-fill me-2"></i>Confirm LPO & Archive
                                </button>
                            </form>
                        </div>
                        {% endif %}

                        {% if job.status == 'archived' %}
                        <div class="text-center p-5">
                            <h5 class="text-muted"><i class="bi bi-archive-fill me-2"></i>Job Archived</h5>
                            <p class="text-muted">This job was completed on {{ job.exited_at|date:"Y-m-d H:i"
                                }}.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {# --- END: Right Column --- #}
</div>
{% block modal %}
<div class="modal fade" id="buyPartModal" tabindex="-1" aria-labelledby="buyPartModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="buyPartForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="buyPartModalLabel">Mark Part as Bought</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="modalPartId" name="part_id">
                    <div class="mb-3">
                        <label for="priceInput" class="form-label">Enter Price</label>
                        <input type="number" class="form-control" id="priceInput" name="price" step="0.01" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Confirm</button>
                </div>
            </form>
        </div>
    </div>
</div>
<div class="modal fade" id="viewPartImageModal" tabindex="-1" aria-labelledby="viewPartImageModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="partImageName">Part Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <img id="partImage" src="" alt="Part Image" class="img-fluid rounded">
            </div>
        </div>
    </div>
</div>

{% endblock modal %}
</div>
{% endblock content %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Modal for setting price
        var buyPartModal = document.getElementById('buyPartModal');
        if (buyPartModal) {
            buyPartModal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var partId = button.getAttribute('data-part-id');
                var partName = button.getAttribute('data-part-name');
                var modalTitle = buyPartModal.querySelector('.modal-title');
                modalTitle.textContent = 'Mark "' + partName + '" as Bought';
                buyPartModal.querySelector('#modalPartId').value = partId;
            });
        }

        // Custom Item Name toggle based on item selection
        const itemSelect = document.getElementById('id_item_name');
        const customNameField = document.getElementById('custom-name-field');
        if (itemSelect && customNameField) {
            function toggleCustomField() {
                if (!itemSelect.value || itemSelect.value === 'custom') {
                    customNameField.style.display = 'block';
                } else {
                    customNameField.style.display = 'none';
                }
            }
            itemSelect.addEventListener('change', toggleCustomField);
            toggleCustomField();
        }

        // Submit buy part form
        const buyPartForm = document.getElementById('buyPartForm');
        if (buyPartForm) {
            buyPartForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const partId = buyPartModal.querySelector('#modalPartId').value;
                const price = buyPartForm.querySelector('input[name="price"]').value;

                // CSRF token from meta tag
                const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

                fetch("{% url 'core:mark_part_as_bought' 0 %}".replace('0', partId), {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({ 'price': price }),
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to mark part as bought.');
                    }
                });
            });
        }

        // View image modal logic
        const viewPartImageModal = document.getElementById('viewPartImageModal');
        if (viewPartImageModal) {
            viewPartImageModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const imageUrl = button.getAttribute('data-part-image-url');
                const partName = button.getAttribute('data-part-name');
                const img = viewPartImageModal.querySelector('#partImage');
                const caption = viewPartImageModal.querySelector('#partImageName');
                img.src = imageUrl;
                caption.textContent = partName;
            });
        }
    });
</script>
{% endblock scripts %}